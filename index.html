<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>EtherCalc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="EtherCalc: Multiplayer Spreadsheet">
    <meta name="author" content="Audrey Tang <audreyt@audreyt.org>">
    <link rel="stylesheet" type="text/css" class="ui" href="./css/semantic.min.css">
    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,200,700' rel='stylesheet' type='text/css'>
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
	font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .chapter a {
        white-space: nowrap;
      }
      .chapter h1 {
        padding-bottom: 20px;
      }
      .chapter img {
        margin-left: 10%;
      }
      .chapter {
        padding-left: 10%;
        padding-right: 10%;
      }
      .chapter h3 {
        font-size: 20px;
      }
      .chapter p, .chapter li {
        font-size: 20px;
        line-height: 140%;
        padding-bottom: 10px;
        text-align: justify;
      }
      .chapter pre, .chapter code {
        font-size: 16px;
        line-height: 125%;
      }
      .hero-unit {
        background: #eeeeff;
      }
      .hero-titles {
        padding-bottom: 5%;
      }
      .logo {
        padding: 8px;
      }
      .prelike {
      display: block;
      padding: 8.5px;
      margin: 0 0 9px;
      font-size: 12.025px;
      line-height: 18px;
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      border: 1px solid rgba(0, 0, 0, 0.15);
      -webkit-border-radius: 4px;
      -moz-border-radius: 4px;
      border-radius: 4px;
      word-break: break-all;
      word-wrap: break-word;
      }
      tr.os td {
      vertical-align: bottom;
      }
      tr.inst td {
      vertical-align: top;
      }
    </style>
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body data-spy="scroll">

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">EtherCalc</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="#about">Try</a></li>
              <li><a href="#install">Install</a></li>
              <li><a href="#preso-en">Slides</a></li>
              <li><a target="_blank" href="https://github.com/audreyt/ethercalc">GitHub</a></li>
              <li><a href="#book">Book:</a></li>
              <li><a href="#ch1">Introduction</a></li>
              <li><a href="#ch2">WikiCalc</a></li>
              <li><a href="#ch3">SocialCalc</a></li>
              <li><a title="Rich-text Editing" href="#ch4">Richtext</a></li>
              <li><a title="Real-time Collaboration" href="#ch5">Collaboration</a></li>
              <li><a title="Lessons Learned" href="#ch6">Lessons</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

      <section id="about">
      <div class="hero-unit">
	<div class="row">
	<div class="span5">
        <p>
            <h1 style="background: #114175 !important; display: inline-block; border-radius: 10px; padding: 10px; margin-bottom: 10px; 
-moz-box-shadow: 3px 3px 3px #888;
-webkit-box-shadow: 3px 3px 3px #888;
box-shadow: 3px 3px 3px #888;
font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
"><span style="color: #B3E2FF">Ether</span><span style="color: #E8F4FF">Calc</style></h1>
            <h2 style="margin-bottom: 20px;
font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;
">EtherCalc is a web spreadsheet.</h2>
        <p>
Your data is saved on the web, and people can edit the same document at the same time. Everybody's changes are instantly reflected on all screens.
        </p>
        <p>
Work together on inventories, survey forms, list management, brainstorming sessions and more!
        </p>
	</div><div class="span5"><img src="//ethercalc.org/static/img/davy/gfx/screenshot.png" style="max-width:120%; border-radius: 10px;
-moz-box-shadow: 5px 5px 3px #888;
-webkit-box-shadow: 5px 5px 3px #888;
box-shadow: 5px 5px 3px #888;
"></div>
	</div>
        <p><a style="
-moz-box-shadow: 2px 2px 3px #888;
-webkit-box-shadow: 2px 2px 3px #888;
box-shadow: 2px 2px 3px #888;
font-weight: normal;
" class="btn btn-primary btn-large" target="_blank" href="//ethercalc.org/_new">Create Spreadsheet &raquo;</a></p>
<a target="_blank" href="https://ethercalc.org/privacy.png">Terms of Service &amp; Privacy Policy</a>
      </div>
      
      <section id="install" class="chapter">
	<div class="page-header">
	  <h1>Installation</h1>
	</div>
	  <p><strong>EtherCalc</strong> is Free Software; it runs on GNU/Linux, FreeBSD, Mac OS X and Windows.</p>
          <p>Please download and install <a href="http://nodejs.org/#download">Node.js</a>, then enter the following command:
<pre>
npm install ethercalc
./node_modules/ethercalc/bin/ethercalc
</pre>

<p>
If you'd like to install for all users on a system, try <code>sudo</code> with <code>npm install -g</code>:
</p>

<pre>
npm install -g ethercalc
ethercalc
</pre>
</p>
<p>If a <a href="http://redis.io/">Redis</a> service is running on the same host, EtherCalc will prefer it over file-based storage to improve performance.</p>
<p>Installation instructions on the <a target="_blank" href="https://sandstorm.io/">Sandstorm</a> platform is available <a target="_blank" href="https://sandstorm.io/install/#EtherCalc">here</a>.
We also provide a <a target="_blank" href="https://registry.hub.docker.com/u/audreyt/ethercalc/">Docker</a> package.</a>
<p>EtherCalc can be installed on a <a target="_blank" href="https://cloudron.io">Cloudron</a> using the <a target="_blank" href="https://cloudron.io/appstore.html?app=net.ethercalc.cloudronapp">EtherCalc app</a>.</p>
      </section>


<div style="float: right; width:425px; margin-left: 10px" id="__ss_12539343"> <strong style="display:block;margin:12px 0 4px"><a href="//www.slideshare.net/autang/ethercalc-video-for-f2f" title="EtherCalc: The Video" target="_blank">EtherCalc: The Video - English</a></strong> <iframe src="//www.slideshare.net/slideshow/embed_code/13001717?rel=0" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div>

      <section id="preso-en" class="chapter">
	<div class="page-header">
	  <h1>Slides</h1>
	</div>
        <ul>
        <li><a href="ethercalc-f2f.key">Download Keynote slides</a> (15MB)</li>
        <li><a href="ethercalc-f2f.pdf">Download PDF slides</a> (20MB)</li>
        <li><a href="//www.slideshare.net/secret/BBgwf8OAGSGgNG">View slides online</a> (SlideShare)</li>
        </ul>
      </section>

      <section id="book" class="chapter">
	<div class="page-header">
	  <h1>Book</h1>
	</div>
        <p>
        Following is the SocialCalc chapter from <a style="white-space: inherit" href="http://aosabook.org/">The Architecture of Open Source Applications</a>, released into the public domain under the <a hre="http://creativecommons.org/choose/zero/">CC0</a> decalaration.
        </p>
        <p>
        If you would like to <a href="http://www.aosabook.org/en/index.html#purchase">purchase the book</a>, all royalties will be donated to <a href="http://amnesty.org/">Amnesty International</a>.
        </p>
      </section>
      <section id="ch1" class="chapter">
	<div class="page-header">
	  <h2>Introduction</h2>
	</div>
<p>The history of spreadsheets spans more than 30 years. The first spreadsheet program, VisiCalc, was conceived by Dan Bricklin in 1978 and shipped in 1979. The original concept was quite straightforward: a table that spans infinitely in two dimensions, its cells populated with text, numbers, and formulas. Formulas are composed of normal arithmetic operators and various built-in functions, and each formula can use the current contents of other cells as values.</p>
</p><p>
Although the metaphor was simple, it had many applications: accounting, inventory, and list management are just a few. The possibilities were practically limitless. All these uses made VisiCalc into the first "killer app" of the personal computer era.
</p><p>
In the decades that followed successors like Lotus 1-2-3 and Excel made incremental improvements, but the core metaphor stayed the same. Most spreadsheets were stored as on-disk files, and loaded into memory when opened for editing. Collaboration was particularly hard under the file-based model:
</p><ul>
<li>Each user needed to install a version of the spreadsheet editor.</li>
<li>E-mail ping-pong, shared folders, or setting up a dedicated version-control system all added bookkeeping overhead.</li>
<li>Change tracking was limited; for example, Excel does not preserve history for formatting changes and cell comments.</li>
<li>Updating formatting or formulas in templates required painstaking changes to existing spreadsheet files that used that template.</li>
</ul><p>
Fortunately, a new collaboration model emerged to address these issues with elegant simplicity. It is the wiki model, invented by Ward Cunningham in 1994, and popularized by Wikipedia in the early 2000s.
</p><p>
Instead of files, the wiki model features server-hosted pages, editable in the browser without requiring special software. Those hypertext pages can easily link to each other, and even include portions of other pages to form a larger page. All participants view and edit the latest version by default, with revision history automatically managed by the server.
</p><p>
Inspired by the wiki model, Dan Bricklin started working on WikiCalc in 2005. It aims to combine the authoring ease and multi-person editing of wikis with the familiar visual formatting and calculating metaphor of spreadsheets.
</p>
      </section>
      <section id="ch2" class="chapter">
	<div class="page-header">
	  <h2>WikiCalc</h2>
	</div>
<p>The first version of WikiCalc had several features that set it apart from other spreadsheets at the time:</p>
<ul>
<li>Plain text, HTML, and wiki-style markup rendering for text data.</li>
<li>Wiki-style text that includes commands to insert links, images, and values from cell references.</li>
<li>Formula cells may reference values of other WikiCalc pages hosted on other websites.</li>
<li>Ability to create output to be embedded in other web pages, both static and live data.</li>
<li>Cell formatting with access to CSS style attributes and CSS classes.</li>
<li>Logging of all edit operations as an audit trail.</li>
<li>Wiki-like retention of each new version of a page with roll-back capability.</li>
</ul>
<p>WikiCalc 1.0's internal architecture and information flow were deliberately simple, but nevertheless powerful. The ability to compose a master spreadsheet from several smaller spreadsheets proved particularly handy. For example, imagine a scenario where each salesperson keeps numbers in a spreadsheet page. Each sales manager then rolls up their reps' numbers into a regional spreadsheet, and the VP of sales then rolls up the regional numbers into a top-level spreadsheet.
</p>
<p>
Each time one of the individual spreadsheets is updated, all the roll-up spreadsheets can reflect the update. If someone wants further detail, they simply click through to view the spreadsheet behind the spreadsheet. This roll-up capability eliminates the redundant and error-prone effort of updating numbers in multiple places, and ensures all views of the information stay fresh.
</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/wikicalc-components.png" alt=""></p>
<p>
To ensure the recalculations are up-to-date, WikiCalc adopted a thin-client design, keeping all the state information on the server side. Each spreadsheet is represented on the browser as a <code>&lt;table&gt;</code> element; editing a cell will send an <code>ajaxsetcell</code> call to the server, and the server then tells the browser which cells need updating.</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/wikicalc-flow.png" alt="" height="240" width="438"></p>
<p>Unsurprisingly, this design depends on a fast connection between the browser and the server. When the latency is high, users will start to notice the frequent appearance of "Loading…" messages between updating a cell and seeing its new contents as shown below. This is especially a problem for users interactively editing formulas by tweaking the input and expecting to see results in real time.</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/wikicalc-loading.png" alt=""></p>
<p>
Moreover, because the <code>&lt;table&gt;</code> element had the same dimensions as the spreadsheet, a 100×100 grid would create 10,000 <code>&lt;td&gt;</code> DOM objects, which strains the memory resource of browsers, further limiting the size of pages.
</p>
<p>Due to these shortcomings, while WikiCalc was useful as a stand-alone server running on localhost, it was not very practical to embed as part of web-based content management systems.
</p>
<p>In 2006, Dan Bricklin teamed up with Socialtext to start developing SocialCalc, a ground-up rewrite of WikiCalc in Javascript based on some of the original Perl code.

</p>
<p>This rewrite was aimed at large, distributed collaborations, and sought to deliver a look and feel more like that of a desktop app. Other design goals included:</p>
<ul>
<li>Capable of handling hundreds of thousands of cells.</li>
<li>Fast turnaround time for edit operations.</li>
<li>Client-side audit trail and undo/redo stack.</li>
<li>Better use of Javascript and CSS to provide full-fledged layout functionality.</li>
<li>Cross-browser support, despite the more extensive use of responsive Javascript.</li>
</ul>
<p>After three years of development and various beta releases, Socialtext released SocialCalc 1.0 in 2009, successfully meeting the design goals. Let's now take a look at the architecture of the SocialCalc system.
</p>
      </section>
      <section id="ch3" class="chapter">
	<div class="page-header">
	  <h2>SocialCalc</h2>
	</div>
<p>SocialCalc's main interface looks like this:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-screenshot.png" alt=""></p>
<p>Its class diagram is as below:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-class-diagram.png" alt="" height="656" width="500"></p>
<p>Compared to WikiCalc, the server's role has been greatly reduced. Its only responsibility is responding to HTTP GETs by serving entire spreadsheets serialized in the save format; once the browser receives the data, all calculations, change tracking and user interaction are now implemented in Javascript.</p>
<p>The Javascript components were designed with a layered MVC (Model/View/Controller) style, with each class focusing on a single aspect:
</p>
<ul>
<li><strong>Sheet</strong>&nbsp;is the data model, representing an in-memory structure of a spreadsheet.
<p>It contains a dictionary from coordinates to <strong>Cell</strong> objects, each representing a single cell. Empty cells need no entries, and hence consume no memory at all.</p>
</li>
<li><strong>Cell</strong>&nbsp;represents a cell's content and formats.
<p>Some common properties are shown below:</p>
<pre>    datatype    t
    datavalue   1Q84
    color       black
    bgcolor     white
    font        italic bold 12pt Ubuntu
    comment     Ichi-Kyu-Hachi-Yon</pre>
</li>
<li><p><strong>RenderContext</strong>&nbsp;implements the view; it is responsible for rendering a sheet into DOM objects.</p></li>
<li><strong>TableControl</strong>&nbsp;is the main controller, accepting mouse and keyboard events.&nbsp;
<p>As it receives view events such as scrolling and resizing, it updates its associated <strong>RenderContext</strong> object.</p>
<p>As it receives update events that affects the sheet's content, it schedules new commands to the sheet's command queue.</p>
</li>
<li><p><strong>SpreadSheetControl</strong>&nbsp;is the top-level UI with toolbars, status bars, dialog boxes and color pickers.</p></li>
<li><strong>SpreadSheetViewer</strong>&nbsp; is an alternate top-level UI that provides a read-only interactive view.</li>
</ul>
<p>We adopted a minimal class-based object system with simple composition/delegation, and make no use of inheritance or object prototypes. All symbols are placed under the <code>SocialCalc.*</code> namespace to avoid naming conflicts.</p>
<p>Each update on the sheet goes through the <code>ScheduleSheetCommands</code>
method, which takes a command string representing the edit.
The application embedding SocialCalc may define extra commands on their
own, by adding named callbacks into the
<code>SocialCalc.SheetCommandInfo.CmdExtensionCallbacks</code> object, and
use the <code>startcmdextension</code> command to invoke them.  Some common commands are shown below:
</p>
<pre>    set     sheet defaultcolor blue
    set     A width 100
    set     A1 value n 42
    set     A2 text t Hello
    set     A3 formula A1*2
    set     A4 empty
    set     A5 bgcolor green
    merge   A1:B2
    unmerge A1
    erase   A2
    cut     A3
    paste   A4
    copy    A5
    sort    A1:B9 A up B down
    name    define Foo A1:A5
    name    desc   Foo Used in formulas like SUM(Foo)
    name    delete Foo
    startcmdextension UserDefined args</pre>
<p>Applciations embedding SocialCalc may define extra commands on their own, by adding named callbacks into the <code>SocialCalc.​SheetCommandInfo.​CmdExtensionCallbacks</code> object, and use the <code>startcmdextension</code> command to invoke them</p>
	<div class="page-header">
<h3>Command Run-Loop</h3>
</div>
<p>To improve responsiveness, SocialCalc performs all recalculation and DOM updates in the background, so the user can keep making changes to several cells while the engine catches up on earlier changes in the command queue.
</p>
<p>When a command is running, the <strong>TableEditor</strong> object sets its
<code>busy</code> flag to true; subsequent commands are then pushed into the
<code>deferredCommands</code> queue, ensuring a sequential order of
execution. The event loop looks like this:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-command-runloop.png" alt="" height="700" width="500"></p>
<p>As the diagram shows, the <strong>Sheet</strong> object keeps sending <code>StatusCallback</code> events to notify the user of the current state of command execution, through each of the four steps:</p>
<ul>
  <li><b>ExecuteCommand</b>
<p>Sends <code>cmdstart</code> upon start, and
  <code>cmdend</code> when the command finishes execution.
</p><p>If the command
  changed a cell's value indirectly, enter the <em>Recalc</em> step.
</p><p>
  Otherwise, if the command changed the visual appearance of one or
  more on-screen cells, enter the <em>Render</em> step.
</p><p>If neither of
  the above applies (for example with the <code>copy</code> command), skip
  to the <em>PositionCalculations</em> step.
</p></li>
  <li><b>Recalc</b> <em>(as needed)</em>
<p>Sends <code>calcstart</code> upon start,
  <code>calcorder</code> every 100ms when checking the dependency chain of
  cells, <code>calccheckdone</code> when the check finishes, and
  <code>calcfinished</code> when all affected cells received their
  re-calculated values.
</p><p>This step is always followed by the <em>Render</em> step.</p></li>

  <li><b>Render</b> <em>(as needed)</em>
<p>Sends <code>schedrender</code> upon
  start, and <code>renderdone</code> when the
  <code>&lt;table&gt;</code> element is updated with
  formatted cells.</p><p>This step is always followed by <em>PositionCalculations</em>.</p></li>
  <li><b>PositionCalculations</b>
<p>Sends <code>schedposcalc</code> upon
  start, and <code>doneposcalc</code> after updating the scrollbars, the
  current editable cell cursor, and other visual components of the
  <code>TableEditor</code>.</p></li>
</ul>
<p>Because all commands are saved as they are executed, we naturally get
an audit log of all operations.  The <code>Sheet.CreateAuditString</code>
method provides a newline-delimited string as the audit trail, with
each command in a single line.</p>
<p><code>ExecuteSheetCommand</code> also creates an undo command for each
command it executes.  For example, if the cell A1 contains "Foo"
and the user executes <code>set A1 text Bar</code>, then an undo-command
<code>set A1 text Foo</code> is pushed to the undo stack.  If the user
clicks Undo, then the undo-command is executed to restore A1 to its
original value.</p>
	<div class="page-header">
<h3>Table Editor</h3>
</div>
<p>Now let's look at the TableEditor layer.  It calculates the on-screen
coordinates of its <code>RenderContext</code>, and manages
horizontal/vertical scroll bars through two <code>TableControl</code>
instances.</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-parts.png" alt=""></p>
<p>The view layer, handled by the <code>RenderContext</code> class, also
differs from WikiCalc's design.  Instead of mapping each cell to a
<code>&lt;td&gt;</code> element, we now simply create a
fixed-size <code>&lt;table&gt;</code> that fits the
browser's visible area, and pre-populate it with
<code>&lt;td&gt;</code> elements.</p>
<p>As the user scrolls the spreadsheet through our custom-drawn scroll
bars, we dynamically update the <code>innerHTML</code> of the pre-drawn
<code>&lt;td&gt;</code> elements.  This means we don't need to
create or destroy any <code>&lt;tr&gt;</code> or
<code>&lt;td&gt;</code> elements in many common cases,
which greatly speeds up response time.</p>
<p>Because <code>RenderContext</code> only renders the visible region, the size
of Sheet object can be arbitrarily large without affecting its
performance.</p>
<p><code>TableEditor</code> also contains a <code>CellHandles</code> object, which
implements the radial fill/move/slide menu attached to the
bottom-right corner to the current editable cell, known as the <code>ECell</code>:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-cell-handles.png" alt=""></p>
<p>The input box is managed by two classes: <code>InputBox</code> and
<code>InputEcho</code>.  The former manages the above-the-grid edit row,
while the latter shows an updated-as-you-type preview layer,
overlaying the ECell's content:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-input.png" alt=""></p>
<p>Usually, the SocialCalc engine only needs to communicate to the server
when opening a spreadsheet for edit, and when saving it back to
server.  For this purpose, the <code>Sheet.ParseSheetSave</code> method
parses a save format string into a <code>Sheet</code> object, and the
<code>Sheet.CreateSheetSave</code> method serializes a <code>Sheet</code> object
back into the save format.</p>
<p>Formulas may refer to values from any remote spreadsheet with a URL.
The <code>recalc</code> command re-fetches the externally referenced
spreadsheets, parses them again with <code>Sheet.ParseSheetSave</code>, and
stores them in a cache so the user can refer to other cells in the
same remote spreadsheets without re-fetching its content.</p>
	<div class="page-header">
<h3>Save Format</h3>
</div>
<p>The save format is in standard MIME <code>multipart/mixed</code> format,
consisting of four <code>text/plain; charset=UTF-8</code> parts, each part
containing newline-delimited text with colon-delimited data fields.
The parts are:</p>

<ul>

  <li>The <code>meta</code> part lists the types of the other parts.</li>

  <li>The <code>sheet</code> part lists each cell's format and content, each
  column's width (if not default), the sheet's default format, followed
  by a list of fonts, colors and borders used in the sheet.</li>

  <li>The optional <code>edit</code> part saves the <code>TableEditor</code>'s
  edit state, including ECell's last position, as well as the fixed sizes of
  row/column panes.</li>

  <li>The optional <code>audit</code> part contains the history of
 commands executed in the previous editing session.</li>

</ul>
<p>For example, here is a spreadsheet with three
cells, with <code>1874</code> in A1 as the ECell, the formula <code>2^2*43</code>
in A2, and the formula <code>SUM(Foo)</code> in A3 rendered in bold,
referring to the named range <code>Foo</code> over <code>A1:A2</code>.</p>

<p><img src="https://github.com/audreyt/socialcalc/wiki/img/socialcalc-2046.png" alt=""></p>
<p>The serialized save format for the spreadsheet looks like this:</p>
<pre>    socialcalc:version:1.0
    MIME-Version: 1.0
    Content-Type: multipart/mixed; boundary=SocialCalcSpreadsheetControlSave
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    # SocialCalc Spreadsheet Control Save
    version:1.0
    part:sheet
    part:edit
    part:audit
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    version:1.5
    cell:A1:v:1874
    cell:A2:vtf:n:172:2^2*43
    cell:A3:vtf:n:2046:SUM(Foo):f:1
    sheet:c:1:r:3
    font:1:normal bold * *
    name:FOO::A1\cA2
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    version:1.0
    rowpane:0:1:14
    colpane:0:1:16
    ecell:A1
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    set A1 value n 1874
    set A2 formula 2^2*43
    name define Foo A1:A2
    set A3 formula SUM(Foo)
    --SocialCalcSpreadsheetControlSave--</pre>
<p class="continue">This format is designed to be human-readable, as well as being
relatively easy to generate programmatically.  This makes it possible
for Drupal's Sheetnode plugin to use PHP to convert
between this format and other popular spreadsheet formats, such as
Excel (<code>.xls</code>) and OpenDocument (<code>.ods</code>).</p>

<p>Now that we have a good idea about how the pieces in SocialCalc fit
together, let's look at two real-world examples of extending
SocialCalc.</p>

      </section>

      <section id="ch4" class="chapter">
	<div class="page-header">
	  <h2>Rich-text Editing</h2>
	</div>
<p>The first example we'll look at is enhancing SocialCalc's text cells
with wiki markup to display its rich-text rendering right in the
table editor:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/richtext-screenshot.png" alt=""></p>
<p>We added this feature to SocialCalc right after its 1.0 release, to
address the popular request of inserting images, links and text
markups using a unified syntax.  Since Socialtext already has an
open-source wiki platform, it was natural to re-use the syntax for
SocialCalc as well.</p>

<p>To implement this, we need a custom renderer for the
<code>textvalueformat</code> of <code>text-wiki</code>, and to change the default
format for text cells to use it.</p>

<p>What is this <code>textvalueformat</code>, you ask?  Read on.</p>

	<div class="page-header">
<h3>Types and Formats</h3>
</div>

<p>In SocialCalc, each cell has a <code>datatype</code> and a <code>valuetype</code>.
Data cells with text or numbers correspond to text/numeric value
types, and formula cells with <code>datatype="f"</code> may generate either
numeric or text values.</p>

<p>Recall that on the Render step, the <code>Sheet</code> object generates HTML
from each of its cells.  It does so by inspecting each cell's
<code>valuetype</code>: If it begins with t, then the cell's
<code>textvalueformat</code> attribute determines how generation is done.
If it begins with <code>n</code>, then the <code>nontextvalueformat</code> attribute is
used instead.</p>

<p>However, if the cell's <code>textvalueformat</code> or
<code>nontextvalueformat</code> attribute is not defined explicitly, then a
default format is looked up from its <code>valuetype</code>, as shown below:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/richtext-formats.png" alt=""></p>

<p class="continue">Support for the <code>text-wiki</code> value format is coded in
<code>SocialCalc.format_text_for_display</code>:</p>
<pre>     if (SocialCalc.Callbacks.expand_wiki
         &amp;&amp; /^text-wiki/.test(valueformat)
     ) { 
         // do general wiki markup 
         displayvalue = SocialCalc.Callbacks.expand_wiki(
             displayvalue, sheetobj, linkstyle, valueformat
         ); 
     } </pre>
<p>Instead of inlining the wiki-to-HTML expander in
<code>format_text_for_display</code>, we will define a new hook in
<code>SocialCalc.​Callbacks</code>.  This is the recommended style
throughout the SocialCalc codebase; it improves modularity by making
it possible to plug in different ways of expanding wikitext, as well
as keeping compatibility with embedders that do not desire this
feature.</p>

	<div class="page-header">
<h3>Rendering Wikitext</h3>
</div>
<p>Next, we'll make use of <a rel="nofollow" href="https://github.com/audreyt/wikiwyg-js">Wikiwyg</a>, a
Javascript library offering two-way conversions between wikitext and
HTML.</p>
<p>We define the <code>expand_wiki</code> function by taking the cell's text,
running it through Wikiwyg's wikitext parser and its HTML emitter:</p>
<pre>     var parser = new Document.Parser.Wikitext(); 
     var emitter = new Document.Emitter.HTML(); 
     SocialCalc.Callbacks.expand_wiki = function(val) { 
         // Convert val from Wikitext to HTML 
         return parser.parse(val, emitter); 
     } </pre>
<p class="continue">The final step involves scheduling the <code>set sheet
defaulttextvalueformat text-wiki</code> command right after the
spreadsheet initializes:</p>
<pre>     // Assume there's a &lt;div id="tableeditor"/&gt; in DOM 
     var spreadsheet = new SocialCalc.SpreadsheetControl(); 
     spreadsheet.InitializeSpreadsheetControl(
         "tableeditor", 0, 0, 0
     ); 
     spreadsheet.ExecuteCommand(
         'set sheet defaulttextvalueformat text-wiki'
     ); </pre>
<p class="continue">Taken together, the Render step now works like this:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/richtext-flow.png" alt=""></p>
<p>That's all!  The enhanced SocialCalc now supports a rich set of wiki
markup syntax:</p>
<pre>    *bold* _italic_ `monospace` {{unformatted}}
    &gt; indented text
    * unordered list
    # ordered list
    "Hyperlink with label"&lt;http://softwaregarden.com/&gt;
    {image: http://www.socialtext.com/images/logo.png}</pre>
<p class="continue">Try entering <code>*bold* _italic_ `monospace`</code> in A1, and you'll
see it rendered as rich text:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/richtext-example.png" alt=""></p>
      </section>

      <section id="ch5" class="chapter">
	<div class="page-header">
	  <h2>Real-time Collaboration</h2>
	</div>


<p>The next example we'll explore is multi-user, real-time editing on a
shared spreadsheet.  This may seem complicated at first, but thanks to
SocialCalc's modular design all it takes is for each on-line user to
broadcast their commands to other participants.</p>

<p>To distinguish between locally-issued commands and remote commands, we
add an <code>isRemote</code> parameter to the <code>ScheduleSheetCommands</code>
method:</p>

<pre>    SocialCalc.ScheduleSheetCommands =
        function(sheet, cmdstr, saveundo, isRemote) {
            if (SocialCalc.Callbacks.broadcast &amp;&amp; !isRemote) {
                SocialCalc.Callbacks.broadcast('execute', {
                    cmdstr: cmdstr,
                    saveundo: saveundo
                });
            }
            // ...original ScheduleSheetCommands code here...
        };</pre>
<p class="continue">Now all we need to do is to define a suitable
<code>SocialCalc.Callbacks.broadcast</code> callback function.  Once it's
in place, the same commands will be executed on all users connected
to the same spreadsheet.</p>

<p>When this feature was first implemented for <a title="One Laptop Per Child" href="http://one.laptop.org/">OLPC</a> by SEETA's <a href="http://seeta.in/wiki/index.php?title=Collaboration_in_SocialCalc">Sugar Labs</a> in 2009, the <code>broadcast</code> function was built with XPCOM calls into D-Bus/Telepathy, the standard transport for OLPC/Sugar networks:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/collab-olpc.png" alt=""></p>
<p>That worked reasonably well, enabling XO instances in the same Sugar
network to collaborate on a common SocialCalc spreadsheet.  However,
it is both specific to the Mozilla/XPCOM browser platform, as well as
to the D-Bus/Telepathy messaging platform.</p>

<h3>Cross-browser Transport</h3>

<p>To make this work across browsers and operating systems, we use the
<a rel="nofollow" href="http://search.cpan.org/dist/Web-Hippie/">Web::Hippie</a>
framework, a high-level abstraction of JSON-over-WebSocket with
convenient jQuery bindings, with MXHR (<a rel="nofollow" href="http://about.digg.com/blog/duistream-and-mxhr">multipart XMLHttpRequest</a>)
as the fallback transport mechanism if WebSocket is not available.</p>

<p>For browsers with Adobe Flash plugin installed but without native
WebSocket support, we use the <a rel="nofollow" href="https://github.com/gimite/web-socket-js">web_socket.js</a><a rel="nofollow" href="https://github.com/gimite/web-socket-js">web_socket.js</a> project's Flash emulation of WebSocket, which is often faster and more reliable
than MXHR.</p>
<p>The operation flow is shown below:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/collab-flow.png" alt=""></p>
<p>The client-side <code>SocialCalc.Callbacks.broadcast</code> function is
defined as:</p>
<pre>    var hpipe = new Hippie.Pipe();

    SocialCalc.Callbacks.broadcast = function(type, data) {
        hpipe.send({ type: type, data: data });
    };

    $(hpipe).bind("message.execute", function (e, d) {
        var ss = SocialCalc.CurrentSpreadsheetControlObject;
        ss.context.sheetobj.ScheduleSheetCommands(
            d.data.cmdstr,
            d.data.saveundo,
            true // isRemote = true
        );
        break;
    });</pre>
<p class="continue">Although this works quite well, there are still two remaining issues
to resolve.</p>
<h3>Conflict Resolution</h3>


<p>The first one is a race-condition in the order of commands executed:
If users A and B simultaneously perform an operation affecting the
same cells, then receive and execute commands broadcast from the other
user, they will end up in different states:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/collab-conflict.png" alt=""></p>
<p>We can resolve this with SocialCalc's built-in undo/redo mechanism, as shown in the diagram below:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/collab-resolution.png" alt=""></p>
<p>The process used to resolve the conflict is as follows:
<ul>
<li>When a client broadcasts a command, it adds the command to a <strong>Pending</strong> queue.</li>
<li>When a client receives a command, it checks the remote command against the <strong>Pending</strong> queue:
<ul>
<li>If the <strong>Pending</strong> queue is empty, then the command is simply executed as a remote action. </li>
<li>If the command matches a command in the <strong>Pending</strong> queue, then the local command is removed from the queue.</li>
<li>Otherwise, check if there are any queued commands that conflict with the received command:
<ul>
<li>If there are conflicting commands, first perform an <code>Undo</code> on those commands, and marks them for later <code>Redo</code>.</li>
<li>After undoing all conflicting commands, execute the remote command as usual.</li>
</ul></li></ul></li>
<li>When a marked-for-redo command is received from the server, execute it again, then remove it from the queue.</li>
</ul>

<h3>Remote Cursors</h3>
<p>Even with race conditions resolved, it is still suboptimal to
accidentally overwrite the cell another user is currently editing.  A
simple improvement is for each client to broadcast its cursor position
to other users, so everyone can see which cells are being worked on.</p>

<p>To implement this idea, we add another <code>broadcast</code> handler to the
<code>MoveECellCallback</code> event:</p>

<pre>    editor.MoveECellCallback.broadcast = function(e) {
        hpipe.send({
            type: 'ecell',
            data: e.ecell.coord
        });
    };

    $(hpipe).bind("message.ecell", function (e, d) {
        var cr = SocialCalc.coordToCr(d.data);
        var cell = SocialCalc.GetEditorCellElement(
            editor, cr.row, cr.col
        );
        // ...decorate cell with styles specific
        //    to the remote user(s) on it...
    });</pre>

<p>To mark cell focus in spreadsheets, it's common to use colored
borders.  However, a cell may already define its own <code>border</code>
property, and since <code>border</code> is mono-colored, it can only
represent one cursor on the same cell.</p>

<p>Therefore, on browsers with support for CSS3, we use the <code>box-shadow</code>
property to represent multiple peer cursors in the same cell:</p>

<pre>    /* Two cursors on the same cell */
    box-shadow: inset 0 0 0 4px red, inset 0 0 0 2px green;</pre>
<p>With four people editing on the same spreadsheet, the screen would look like this:</p>
<p><img src="https://github.com/audreyt/socialcalc/wiki/img/collab-borders.png" alt=""></p>
                        
      </section>

      <section id="ch6" class="chapter">
	<div class="page-header">
	  <h2>Lessons Learned</h2>
	</div>

<p>We delivered SocialCalc 1.0 on October 19th, 2009, the 30th
anniversary of the initial release of VisiCalc.  The experience of
collaborating with my colleagues at Socialtext under Dan Bricklin's
guidance was very valuable to me, and I'd like to share some lessons
I learned during that time.</p>
	<div class="page-header">
<h3>Chief Designer with a Clear Vision</h3>
</div>
<p>In his book <strong>The Design of Design</strong>, Fred Brooks argues that when building
complex systems, the conversation is much more direct if we focus on a
coherent <em>design concept</em>, rather than derivative
representations. According to Brooks, the formulation of such a
coherent design concept is best kept in a single person's mind:</p>

<blockquote>

  <p>Since conceptual integrity is the most important attribute of a
  great design, and since that comes from one or a few minds working
  <em>uno animo</em>, the wise manager boldly entrusts each design task to a
  gifted chief designer.</p>

</blockquote>

<p>In the case of SocialCalc, having Tracy Ruggles as our chief
user-experience designer was the key for the project to converge
toward a shared vision.  Since the underlying SocialCalc engine was
so malleable, the temptation of feature creep was very real. Tracy's
ability to communicate using design sketches really helped us
present features in a way that feels intuitive to users.</p>
	<div class="page-header">
<h3>Wikis for Project Continuity</h3>
</div>


<p>Before I joined the SocialCalc project, there was already over two
years' worth of ongoing design and development, but I was able to
catch up and start contributing in less than a week, simply due to
the fact that <em>everything is in the wiki</em>. From the earliest
design notes to the most up-to-date browser support matrix, the
entire process was chronicled in wiki pages and SocialCalc
spreadsheets.</p>

<p>Reading through the project's workspace brought me quickly to the same
page as others, without the usual hand-holding overhead
typically associated with orienting a new team member.</p>

<p>This would not be possible in traditional open source projects, where
most conversation takes place on IRC and mailing lists and the wiki
(if present) is only used for documentations and links to development
resources.  For a newcomer, it's much more difficult to reconstruct
context from unstructured IRC logs and mail archives.</p>

	<div class="page-header">
<h3>Embrace Time Zone Differences</h3>
</div>
<p>David Heinemeier Hansson, creator of Ruby on Rails, once remarked on
the benefit of distributed teams when he first joined 37signals:</p>
<blockquote><p>The seven time zones between Copenhagen and Chicago actually meant that
we got a lot done with few interruptions.</p></blockquote>
<p>With nine time zones
between Taipei and Palo Alto, that was true for us during
SocialCalc's development as well.</p>
<p>We often completed an entire Design-Development-QA feedback cycle
within a 24-hour day, with each aspect taking one person's 8-hour
work day in their local daytime.  This asynchronous style of
collaboration compelled us to produce self-descriptive artifacts
(design sketch, code and tests), which in turn greatly improved our
trust in each other.</p>
	<div class="page-header">
<h3>Optimize for Fun</h3>
</div>
<p>In my 2006 keynote for the CONISLI conference <a href="http://www.slideshare.net/autang/ofun-optimizing-for-fun">-OFun: Optimizing for Fun</a>, I summarized my experience leading a distributed team implementing the Perl 6 language into a few observations.  Among them, <em>Always
 have a Roadmap</em>, <em>Forgiveness &gt; Permission</em>,
<em>Remove deadlocks</em>, <em>Seek ideas, not consensus</em>, and
<em>Sketch ideas with code</em> are particularly relevant for small
distributed teams.</p>

<p>When developing SocialCalc, we took great care in distributing
knowledge among team members with collaborative code ownership, so
nobody would become a critical bottleneck.</p>

<p>Furthermore, we pre-emptively resolved disputes by actually coding up
alternatives to explore the design space, and were not afraid of
replacing fully-working prototypes when a better design arrived.</p>

<p>These cultural traits helped us foster a sense of anticipation and
camaraderie despite the absence of face-to-face interaction, kept
politics to a minimum, and made working on SocialCalc a lot of fun.</p>
	<div class="page-header">
<h3>Drive Development with Story Tests</h3>
</div>
<p>Prior to joining Socialtext, I've advocated the "interleave tests
with the specification" approach, as can be seen in the <a href="http://perlcabal.org/syn/S02.html">Perl 6 specification</a>, where
we annotate the language specification with the official test suite.
</p><p>
However, it was Ken Pier and Matt Heusser, the QA team for SocialCalc,
who really opened my eyes to how this can be taken to the next level,
bringing tests to the place of <em>executable specification</em>.</p>

<p>In Chapter 16 of <cite>Beautiful Testing</cite>, Matt explained our story-test driven development process as follows:</p>


<blockquote>

  <p>The basic unit of work is a "story," which is an extremely
  lightweight requirements document.
</p>
<p>A story contains a brief
  description of a feature along with examples of what needs to happen
  to consider the story completed; we call these examples "acceptance
  tests" and describe them in plain English.</p>

  <p>During the initial cut of the story, the product owner makes a
  good-faith first attempt to create acceptance tests, which are
  augmented by developers and testers before any developer writes
  a line of code.</p>

</blockquote>

<p>hese story tests are then translated into wikitests, a table-based
specification language inspired by 
Ward Cunningham's <a href="http://fit.c2.com/">FIT framework</a>, which drives automated
testing frameworks such as <a href="http://search.cpan.org/dist/Test-WWW-Mechanize/">Test​::WWW​::Mechanize</a> and <a href="http://search.cpan.org/dist/Test-WWW-Selenium/">Test​::WWW​::Selenium</a>.</p>
<p>It's hard to overstate the benefit of having story tests as a common
language to express and validate requirements. It was instrumental in
reducing misunderstanding, and has all but eliminated regressions from
our monthly releases.</p>


	<div class="page-header">
<h3>Open Source With CPAL</h3>
</div>


<p>Last but not least, the open source model we chose for SocialCalc
makes an interesting lesson in itself.</p>
<p>Socialtext created the <a href="https://www.socialtext.net/open/cpal">Common Public Attribution License</a> for
SocialCalc.  Based on the Mozilla Public License, CPAL is designed to
allow the original author to require an attribution to be displayed
on the software's user interface, and has a network-use clause that
triggers share-alike provisions when derived work is hosted by a
service over the network.</p>
<p>After its approval by both the <a href="http://opensource.org/">Open Source Initiative</a> and the <a href="http://www.fsf.org/">Free Software Foundation</a>, we've seen prominent sites such as <a href="https://github.com/facebook/platform">Facebook</a> and <a href="https://github.com/reddit/reddit">Reddit</a> opting to release
their platform's source code under the CPAL, which is very
encouraging.</p>


<p>Because CPAL is a "weak copyleft" license, developers can freely
combine it with either free or proprietary software, and only need to
release modifications to SocialCalc itself.  This enabled various
communities to adopt SocialCalc and made it more awesome.</p>

<p>Examples from this chapter, including rich-text and collaborative editing, can be found on <a href="http://github.com/audreyt/ethercalc">http://github.com/audreyt/ethercalc</a>.
A historical archive of WikiCalc 1.0 is available on <a href="http://github.com/audreyt/wikicalc">http://github.com/audreyt/wikicalc</a> as well.</p>

<p>There are many interesting possibilities with this open-source
spreadsheet engine, and if you can find a way to embed SocialCalc
into your favorite project, we'd definitely love to hear about it.</p>

<p>Happy Hacking!</p>
<p style="font-family: Zapfino; padding-top: 1ex">Audrey Tang</p>
      </section>

      <hr>
<article data-task-list-update-url="/audreyt/3978463/file/posa.mkdn" class="markdown-body js-file js-task-list-container is-task-list-enabled">

      <section id="cha" class="chapter">
        <h1><a rel="noreferrer" href="#from-socialcalc-to-ethercalc" class="anchor" name="from-socialcalc-to-ethercalc"><span class="octicon octicon-link"></span></a>From SocialCalc to EtherCalc</h1>
<p>Previously, in <a rel="noreferrer" href="http://www.aosabook.org/en/socialcalc.html">The Architecture of Open Source Applications</a>, I described SocialCalc, an in-browser spreadsheet system that replaced the server-centric WikiCalc architecture. SocialCalc performs all of its computations in the browser; it uses the server only for loading and saving spreadsheets.</p>

<p>For the Socialtext team, performance was the primary goal behind SocialCalc's design in 2006. The key observation was this: Client-side computation in JavaScript, while an order of magnitude slower than server-side computation in Perl, was still much faster than the network latency incurred during AJAX roundtrips:</p>

<hr>
<img style="width: 80%; max-width:80%;" src="wikicalc-socialcalc.png" title="Since 2009, advances in JavaScript runtimes have reduced the 50ms to &lt;10ms." alt="WikiCalc and SocialCalc's performance model">


<hr><p>Toward the end of the AOSA chapter, we introduced simultaneous collaboration on spreadsheets, using a simple, chatroom-like architecture:</p>

<hr><img style="width: 80%; max-width:80%;" src="multiplayer-socialcalc.png" alt="Multiplayer SocialCalc">

<hr><p>However, as we began to test it for production deployment, the performance and scalability characteristics fell short of practical use, motivating a series of system-wide rewrites in order to reach acceptable performance.</p>

<p>This chapter will discuss the revamped architecture we made for <a rel="noreferrer" href="http://ethercalc.net/">EtherCalc</a>, a successor to SocialCalc optimized toward simultaneous editing. We'll see how we arrived at that architecture, how we used profiling tools, and how we made new tools to overcome performance problems.</p>

</section><section id="chb" class="chapter">
<h1>
<a rel="noreferrer" href="#design-constraints" class="anchor" name="design-constraints"><span class="octicon octicon-link"></span></a>Design Constraints</h1>

<p>The Socialtext platform has both behind-the-firewall and in-the-cloud deployment options, imposing unique constraints on EtherCalc's resource and performance requirements. At the time of this writing, Socialtext requires 2 CPU cores and 4GB RAM for vSphere-based intranet hosting; a typical dedicated EC2 instance provides about twice that capacity, with 4 cores and 7.5GB of RAM.</p>

<p>Deploying on intranets means that we can't simply throw hardware at the problem in the same way multi-tenant, hosted-only systems did (e.g., DocVerse, which later became part of Google Docs); we can assume only a modest amount of server capacity.</p>

<p>Compared to intranet deployments, cloud-hosted instances offer better capacity and on-demand extension, but network connections from browsers are usually slower and fraught with frequent disconnections and reconnections.</p>

<p>To recap, constraints on these resources shaped EtherCalc's architecture directions:</p>

<ul>
<li><p><strong>Memory</strong>: An event-based server allows us to scale to thousands of concurrent connections with a small amount of RAM.</p></li>
<li><p><strong>CPU</strong>: Based on SocialCalc's original design, we offload most computations and all content rendering to client-side JavaScript.</p></li>
<li><p><strong>Network</strong>: By sending spreadsheet operations, instead of spreadsheet content, we reduce bandwidth use and allow recovering over unreliable network connections.</p></li>
</ul>

</section><section id="chc" class="chapter">
<h1>
<a rel="noreferrer" href="#initial-prototype" class="anchor" name="initial-prototype"><span class="octicon octicon-link"></span></a>Initial Prototype</h1>

<p>We started with a WebSocket server implemented in Perl 5, backed by <a rel="noreferrer" href="https://metacpan.org/release/Feersum">Feersum</a>, a <a rel="noreferrer" href="http://software.schmorp.de/pkg/libev.html">libev</a>-based non-blocking web server developed at Socialtext. Feersum is very fast, capable of handling over 10k requests per second on a single CPU.</p>

<p>On top of Feersum, we use the <a rel="noreferrer" href="https://metacpan.org/release/PocketIO">PocketIO</a> middleware to leverage the popular Socket.io JavaScript client, which provides backward compatibility for legacy browsers without WebSocket support.</p>

<p>The initial prototype closely resembles a chat server. Each collaborative session is a chatroom; clients sends their locally executed commands and cursor movements to the server, which relays them to all other clients in the same room.</p>

<p>A typical flow of operation looks like this:</p>

<hr><img style="width: 80%; max-width:80%;" src="flow-prototype.png" alt="Prototype server with log and playback">

<hr><p>Each command is logged on the server with a timestamp. If a client drops and reconnects, it can resume by asking for a log of all requests since it was disconnected, then replay those commands locally to get to the same state as its peers.</p>

<p>As we described in the AOSA chapter, this simple design minimized server-side CPU and RAM requirements, and demonstrates reasonable resiliency against network failure.</p>

</section><section id="chd" class="chapter">
<h1>
<a rel="noreferrer" href="#first-bottleneck" class="anchor" name="first-bottleneck"><span class="octicon octicon-link"></span></a>First Bottleneck</h1>

<p>When the prototype was put to field testing in June 2011, we quickly discovered a performance problem with long-running sessions.</p>

<p>Spreadsheets are long-lived documents, and a collaborative session can accumulate thousands of modifications over weeks of editing.</p>

<p>Under the naive backlog model, when a client joins such an edit session, it must replay thousands of commands, incurring a significant startup delay before it can make any modifications.</p>

<p>To mitigate this issue, we implemented a snapshot mechanism. After every 100 commands sent to a room, the server will poll the states from each active client, and save the latest snapshot it receives next to the backlog. A freshly joined client receives the snapshot along with new commands entered after the snapshot was taken, so it only needs to replay 99 commands at most.</p>

<hr><img style="width: 80%; max-width:80%;" src="flow-snapshot.png" alt="Prototype server with snapshot mechanism">

<hr><p>This workaround solved the CPU issue for new clients, but created a network performance problem of its own, as it taxes each client's upload bandwidth. Over a slow connection, this delays the reception of subsequent commands from the client.</p>

<p>Moreover, the server has no way to validate the consistency of snapshots submitted by clients. Therefore, an erroneous -- or malicious -- snapshot can corrupt the state for all newcomers, placing them out of sync with existing peers.</p>

<p>An astute reader may note that both problems are caused by the server's inability to execute spreadsheet commands. If the server can update its own state as it receives each command, it would not need to maintain a command backlog at all.</p>

<p>The in-browser SocialCalc engine is written in JavaScript. We considered translating that logic into Perl, but that carries the steep cost of maintaining two codebases going forward. We also experimented with embedded JS engines (<a rel="noreferrer" href="https://metacpan.org/release/JavaScript-V8">V8</a>, <a rel="noreferrer" href="https://metacpan.org/release/JavaScript-SpiderMonkey">SpiderMonkey</a>), but they imposed their own performance penalties when running inside Feersum's event loop.</p>

<p>Finally, by August 2011, we resolved to rewrite the server in Node.js.</p>

</section><section id="che" class="chapter">
<h1>
<a rel="noreferrer" href="#porting-to-nodejs" class="anchor" name="porting-to-nodejs"><span class="octicon octicon-link"></span></a>Porting to Node.js</h1>

<p>The initial rewrite went smoothly, because both Feersum and Node.js are based on the same libev event model, and Pocket.io's API matches Socket.io closely.</p>

<p>It took us only an afternoon to code up a functionally equivalent server in just 80 lines of code, thanks to the concise API offered by <a rel="noreferrer" href="http://zappajs.org/">ZappaJS</a>.</p>

<p>Initial <a rel="noreferrer" href="http://c9s.github.com/BenchmarkTest/">micro-benchmarking</a> showed that porting to Node.js costed us about one half of maximum throughput: On a typical Core i5 CPU in 2011, the original Feersum+Tatsumaki stack handles 5k request per second, while Node.js+Express maxes out at 2.8k requests.</p>

<p>This performance degradation was acceptable for our first JavaScript port, as it wouldn't significantly increase latency for users, and we expect that it will improve over time.</p>

<p>Subsequently, we continued the work to reduce client-side CPU use and minimize bandwidth use by tracking each session's ongoing state with server-side SocialCalc spreadsheets:</p>

<hr><img style="width: 80%; max-width:80%;" src="flow-nodejs.png" alt="Maintaining spreadsheet state with Node.js server">

</section><section id="chf" class="chapter">
<hr><h1>
<a rel="noreferrer" href="#server-side-socialcalc" class="anchor" name="server-side-socialcalc"><span class="octicon octicon-link"></span></a>Server-side SocialCalc</h1>

<p>The key enabling technology for our work is <a rel="noreferrer" href="https://github.com/tmpvar/jsdom">jsdom</a>, a full implementation of the W3C document object model, which enables Node.js to load client-side JavaScript libraries within a simulated browser environment.</p>

<p>Using jsdom, it's trivial to create any number of server-side SocialCalc spreadsheets, each taking about 30kb of RAM, running in its own sandbox:</p>

<pre><code>require! &lt;[ vm jsdom ]&gt;
create-spreadsheet = -&gt;
  document = jsdom.jsdom \&lt;html&gt;&lt;body/&gt;&lt;/html&gt;
  sandbox  = vm.createContext window: document.createWindow! &lt;&lt;&lt; {
    setTimeout, clearTimeout, alert: console.log
  }
  vm.runInContext """
    #packed-SocialCalc-js-code
    window.ss = new SocialCalc.SpreadsheetControl
  """ sandbox
</code></pre>

<p>Each collaboration session corresponds to a sandboxed SocialCalc controller, executing commands as they arrive. The server then transmits this up-to-date controller state to newly joined clients, removing the need for backlogs altogether.</p>

<p>Satisfied with benchmarking results, we coded up a <a rel="noreferrer" href="http://redis.io/">Redis</a>-based persistence layer and launched <a rel="noreferrer" href="http://ethercalc.org/">EtherCalc.org</a> for public beta testing. For the next six months, it scaled remarkably well, performing millions of spreadsheet operations without a single incident.</p>

<p>In April 2012, after delivering a talk on EtherCalc at the OSDC.tw conference, I was invited by Trend Micro to participate in their hackathon, adapting EtherCalc into a programmable visualization engine for their real-time web traffic monitoring system.</p>

<p>For their use case, we created REST APIs for accessing individual cells with GET/PUT as well as POSTing commands directly to a spreadsheet. During the hackathon, the brand-new REST handler received hundreds of calls per second, updating graphs and formula cell contents on the browser without any hint of slowdown or memory leaks.</p>

<p>However, at the end-of-day demo, as we piped traffic data into EtherCalc and started to type formulas into the in-browser spreadsheet, the server suddenly locked up, freezing all active connections. We restarted the Node.js process, only to find it consuming 100% CPU, locking up again soon after.</p>

<p>Flabbergasted, we rolled back to a smaller data set, which did work correctly and allowed us to finish the demo. But I wondered: What caused the lock-up in the first place?</p>

</section><section id="chg" class="chapter">
<h1>
<a rel="noreferrer" href="#profiling-nodejs" class="anchor" name="profiling-nodejs"><span class="octicon octicon-link"></span></a>Profiling Node.js</h1>

<p>To find out where those CPU cycles went to, we need a profiler.</p>

<p>Profiling the initial Perl prototype had been very straightforward, thanks largely to the illustrious <a rel="noreferrer" href="https://metacpan.org/module/Devel::NYTProf">NYTProf</a> profiler, which provides per-function, per-line, per-opcode and per-block timing information, with detailed <a rel="noreferrer" href="https://metacpan.org/module/nytprofcg">call-graph visualization</a> and HTML reports. In addition to NYTProf, we also traced long-running processes with Perl's built-in <a rel="noreferrer" href="https://metacpan.org/module/perldtrace">DTrace support</a>, obtaining real-time statistics on function entry and exit.</p>

<p>In contrast, Node.js's profiling tools leave much to be desired. As of this writing, DTrace support is still limited to <a rel="noreferrer" href="http://blog.nodejs.org/2012/04/25/profiling-node-js/">illumos-based systems</a> in 32-bit mode, so we mostly relied on the <a rel="noreferrer" href="https://github.com/c4milo/node-webkit-agent">Node Webkit Agent</a>, which provides an accessible profiling interface, albeit with only function-level statistics.</p>

<p>A typical profiling session looks like this:</p>

<pre><code># "lsc" is the LiveScript compiler
# Load WebKit agent, then run app.js:
lsc -r webkit-devtools-agent -er ./app.js
# In another terminal tab, launch the profiler:
killall -USR2 node
# Open this URL in a WebKit browser to start profiling:
open http://tinyurl.com/node0-8-agent
</code></pre>

<p>To recreate the heavy background load, we performed high-concurrency REST API calls with <a rel="noreferrer" href="http://httpd.apache.org/docs/trunk/programs/ab.html">ab</a>. For simulating browser-side operations, such as moving cursors and updating formulas, we used <a rel="noreferrer" href="http://zombie.labnotes.org/">Zombie.js</a>, a headless browser, also built with jsdom and Node.js.</p>

<p>Ironically, the bottleneck turns out to be in jsdom itself:</p>

<hr><img style="width: 80%; max-width:80%;" src="profiler-jsdom.png" title="ab -n 10000 /_/1/html # 540rps" alt="Profiler Screenshot (with jsdom)">

<p>From the report above, we can see that <code>RenderSheet</code> dominates the CPU use: Each time the server receives a command, it spends a few microseconds to redraw the <code>innerHTML</code> of cells to reflect the effect of the command.</p>

<p>Because all jsdom code run in a single thread, subsequent REST API calls are blocked until the previous command's rendering completes. Under high concurrency, this queue eventually triggered a latent bug that ultimately resulted in server lock-up.</p>

<p>As we scrutinized the heap usage, we saw that the rendered result is all but unreferenced, as we don't really need a real-time HTML display on the server side. The only reference to it is in the HTML export API, and for that we can always reconstruct each cell's <code>innerHTML</code> rendering from the spreadsheet's in-memory structure.</p>

<p>So, we removed jsdom from the <code>RenderSheet</code> function, re-implemented a minimal DOM in <a rel="noreferrer" href="https://github.com/audreyt/ethercalc/commit/fc62c0eb#L1R97">20 lines of LiveScript</a> for HTML export, then ran the profiler again:</p>

<hr><img style="width: 80%; max-width:80%;" src="profiler-no-jsdom.png" title="ab -n 10000 /_/1/html # 2116rps" alt="Updated Profiler Screenshot (without jsdom)">

<p>Much better! We have improved throughput by a factor of 4, HTML exporting is 20 times faster, and the lock-up problem is gone.</p>

</section><section id="chh" class="chapter">
<h1>
<a rel="noreferrer" href="#multi-core-scaling" class="anchor" name="multi-core-scaling"><span class="octicon octicon-link"></span></a>Multi-Core Scaling</h1>

<p>After this round of improvement, we finally felt comfortable enough to integrate EtherCalc into the Socialtext platform, providing simultaneous editing for wiki pages and spreadsheets alike.</p>

<p>To ensure a fair response time on production environments, we deployed a reverse-proxying nginx server, using its <a rel="noreferrer" href="http://wiki.nginx.org/HttpLimitReqModule#limit_req">limit_req</a> directive to put an upper limit on the rate of API calls. This technique proved satisfactory for both behind-the-firewall and dedicated-instance hosting scenarios.</p>

<p>For small and medium-sized enterprise customers, though, Socialtext provides a third deployment option: Multi-tenant hosting. A single, large server hosts more than 35,000 companies, each averaging around 100 users.</p>

<p>In this multi-tenant scenario, the rate limit is shared by all customers making REST API calls. This makes each client's effective limit much more constraining -- around 5 requests per second. As noted in the previous section, this limitation is caused by Node.js using only one CPU for all its computation:</p>

<hr><img style="width: 80%; max-width:80%;" src="scaling-evented.png" alt="Event Server (single-core)">

<hr><p>Is there a way to make use of all those spare CPUs in the multi-tenant server?</p>

<p>For other Node.js services running on multi-core hosts, we utilized a pre-forking <a rel="noreferrer" href="https://npmjs.org/package/cluster-server">cluster server</a> that creates a process for each CPU:</p>

<hr><img style="width: 80%; max-width:80%;" src="scaling-cluster.png" alt="Event Cluster Server (multi-core)">

<hr><p>However, while EtherCalc does support multi-server scaling with Redis, the interplay of <a rel="noreferrer" href="http://stackoverflow.com/a/5749667">Socket.io clustering</a> with <a rel="noreferrer" href="https://github.com/LearnBoost/Socket.IO/wiki/Configuring-Socket.IO">RedisStore</a> in a single server would have massively complicated the logic, making debugging much more difficult.</p>

<p>Moreover, if all processes in the cluster are tied in CPU-bound processing, subsequent connections would still get blocked.</p>

<p>Instead of pre-forking a fixed number of processes, we sought a way to create one background thread for each server-side spreadsheet, thereby distributing the work of command execution among all CPU cores:</p>

<hr><img style="width: 80%; max-width:80%;" src="scaling-threads.png" alt="Event Threaded Server (multi-core)">

<hr><p>For our purpose, the W3C <a rel="noreferrer" href="http://www.w3.org/TR/workers/">Web Worker</a> API is a perfect match. Originally intended for browsers, it defines a way to run scripts in the background independently. This allows long tasks to be executed continuously while keeping the main thread responsive.</p>

<p>So we created <a rel="noreferrer" href="https://github.com/audreyt/node-webworker-threads">webworker-threads</a>, a cross-platform implementation of the Web Worker API for Node.js.</p>

<p>Using webworker-threads, it's very straightforward to create a new SocialCalc thread and communicate with it:</p>

<pre><code>{ Worker } = require \webworker-threads
w = new Worker \packed-SocialCalc.js
w.onmessage = (event) -&gt; ...
w.postMessage command
</code></pre>

<p>This solution offers the best of both worlds: It gives us the freedom to allocate more CPUs to EtherCalc whenever needed, and the overhead of background thread creation remains negligible on single-CPU environments.</p>

</section><section id="chi" class="chapter">
<h1>
<a rel="noreferrer" href="#lessons-learned" class="anchor" name="lessons-learned"><span class="octicon octicon-link"></span></a>Lessons Learned</h1>

<p>Unlike the SocialCalc project's well-defined specification and team development process, EtherCalc was a solo experiment from mid-2011 to late-2012 and served as a proving ground for assessing Node.js' readiness for production use.</p>

<p>This unconstrained freedom afforded an exciting opportunity to try all sorts of alternative languages, libraries, algorithms and architectures. Here, I'd like to share a few lessons I've learned during this 18-month experiment.</p>

<h2>
<a rel="noreferrer" href="#constraints-are-liberating" class="anchor" name="constraints-are-liberating"><span class="octicon octicon-link"></span></a>Constraints are Liberating</h2>

<p>In his book <em>The Design of Design</em>, Fred Brooks argues that by shrinking the designer's search space, constraints can help to focus and expedite a design process. This includes self-imposed constraints:</p>

<blockquote>
<p>Artificial constraints for one's design task have the nice property that one is free to relax them. Ideally, they push one into an unexplored corner of a design space, stimulating creativity.</p>
</blockquote>

<p>During EtherCalc's development, such constraints were essential to maintain its conceptual integrity throughout various iterations.</p>

<p>For example, it might seem attractive to adopt three different concurrency architectures, each tailored to one of our server flavors  (intranet, internet, and multi-tenant hosting). However, such premature optimization would have severely hampered the conceptual integrity.</p>

<p>Instead, I kept the focus on getting EtherCalc performing well without trading off one resource requirement for another, thereby minimizing its CPU, RAM and network uses at the same time. Indeed, since the RAM requirement is under 100MB, even embedded platforms, such as Raspberry Pi, can host it easily.</p>

<p>This self-imposed constraint made it possible to deploy EtherCalc on PaaS environments (e.g. DotCloud, Nodejitsu and Heroku) where all three resources are constrained instead of just one. This made it very easy for people to set up a personal spreadsheet service, thus prompting more contributions from independent integrators.</p>

<h2>
<a rel="noreferrer" href="#worst-is-best" class="anchor" name="worst-is-best"><span class="octicon octicon-link"></span></a>Worst is Best</h2>

<p>At the YAPC::NA 2006 conference in Chicago, I was invited to predict the open-source landscape, and this was my <a rel="noreferrer" href="http://pugs.blogs.com/pugs/2006/06/my_yapcna_light.html">entry</a>:</p>

<blockquote>
<p>I think, but I cannot prove, that next year JavaScript 2.0 will bootstrap itself, complete self-hosting, compile back to JavaScript 1, and replace Ruby as the Next Big Thing on all environments.  </p>

<p>I think CPAN and JSAN will merge; JavaScript will become the common backend for all dynamic languages, so you can write Perl to run in the browser, on the server, and inside databases, all with the same set of development tools.</p>

<p>Because, as we know, <em>Worse is better</em>, so the <em>worst</em> scripting language is doomed to become the <em>best</em>.</p>
</blockquote>

<p>The vision turned into reality around 2009 with the advent of new JavaScript engines running at the speed of native machine instructions. By 2012, JavaScript has become a "write once, run anywhere" virtual machine; other major languages, including <a rel="noreferrer" href="http://perlito.org/">Perl</a>, can be compiled to it.</p>

<p>In addition to browsers on the client side and Node.js on the server, JavaScript also <a rel="noreferrer" href="http://postgre.st/">made headway</a> into the Postgres database with freely reusable <a rel="noreferrer" href="https://npmjs.org/">modules</a> shared by all three runtime environments.</p>

<p>What enabled such sudden growth for the community? During the course of EtherCalc's development, from participating in the fledgling NPM community, I reckoned that it was precisely because JavaScript prescribes very little and bends itself to the various uses, so innovators can focus on the vocabulary and idioms (e.g., jQuery and Node.js), each team abstracting their own <em>Good Parts</em> from a common, liberal core.</p>

<p>New users are offered a very simple subset to begin with; experienced developers are presented with the challenge to evolve better conventions from existing ones. Instead of relying on a core team of designers to get a complete language right for all anticipated uses, the grassroots development of JavaScript echoes Richard P. Gabriel's well-known concept of <a rel="noreferrer" href="http://www.dreamsongs.com/WorseIsBetter.html">Worse is Better</a>.</p>

<h2>
<a rel="noreferrer" href="#livescript-redux" class="anchor" name="livescript-redux"><span class="octicon octicon-link"></span></a>LiveScript, Redux</h2>

<p>In contrast to the straightforward Perl syntax of <a rel="noreferrer" href="https://metacpan.org/module/Coro::AnyEvent">Coro::AnyEvent</a>, the callback-based API of Node.js necessitates deeply nested functions that are difficult to reuse.</p>

<p>After experimenting with various flow-control libraries, I finally solved this issue by settling on <a rel="noreferrer" href="http://livescript.net/">LiveScript</a>, a new language that compiles to JavaScript, with syntax heavily inspired by Haskell and Perl.</p>

<p>In fact, EtherCalc was ported through a lineage of four languages: JavaScript, CoffeeScript, Coco and  LiveScript. Each iteration brings more expressivity, while maintaining full back- and forward compatibility, thanks to efforts such as <a rel="noreferrer" href="http://js2coffee.org/">js2coffee</a> and <a rel="noreferrer" href="http://js2ls.org/">js2ls</a>.</p>

<p>Because LiveScript compiles to JavaScript rather than interprets its own bytecode, it takes full advantage of modern native runtimes and remains completely compatible with function-scoped profilers.</p>

<p>LiveScript eliminated nested callbacks with novel constructs, such as <a rel="noreferrer" href="http://livescript.net/#backcalls">backcalls</a> and <a rel="noreferrer" href="http://livescript.net/#cascades">cascades</a>; it provides us with powerful syntactic tools for functional and object-oriented composition.</p>

<p>When I first encountered LiveScript, I remarked that it's like "a smaller language within Perl 6, struggling to get out..." -- a goal made much easier by focusing strictly on syntactical ergonomics and assuming the same JavaScript semantics.</p>

<h2>
<a rel="noreferrer" href="#freedom-zero" class="anchor" name="freedom-zero"><span class="octicon octicon-link"></span></a>Freedom Zero</h2>

<p>The Free Software Foundation maintains there are four criteria of software freedom. The most basic one, termed Freedom 0, is simply "the freedom to run the program, for any purpose."</p>

<p>In the 20th century, both open-source and proprietary software afforded this freedom, so much so that we almost took it for granted until cloud computing came along.</p>

<p>Hosting data on shared servers is not a new idea. Remote storage services had a history almost as long as the Internet itself, and they generally worked well with ever-improving transport and encryption technologies to guard against data loss and tampering.</p>

<p>However, by the turn of the century, remote storage became increasingly tightly coupled with remote computing and communication. Once we offload computation to a server, it's no longer possible to <em>run the program for any purpose</em>. Rather, the service operator dictates its purpose, holding the power to inspect and censor user data without notice.</p>

<p>Hence, in addition to the well-known importance of having local access to the source code of services we rely on, it's also important to compute only on servers we trust. To serve this purpose, EtherCalc is designed to be easily installable, so it can always run from your own computer.</p>

<p>For the SocialCalc spreadsheet engine, Socialtext designed the <a rel="noreferrer" href="https://www.socialtext.net/open/cpal">Common Public Attribution License</a>. By enabling users to request a copy of the original JavaScript source code they're running from server operators, we encouraged operators to contribute back their code.</p>

<p>As for the server-side code of EtherCalc, I have dedicated it into the <a rel="noreferrer" href="https://creativecommons.org/publicdomain/zero/1.0">public domain</a> to encourage integration with content hosting systems, so anybody can set up a collaborative spreadsheet easily. Many people have indeed done so, and you're welcome to join us, too!</p>
</section>
      </article>
<img width="50%" style="max-width:34%; margin-top: 50px; margin-left: 33%" alt="唐鳳 Audrey Tang" src="ethercalc.tw.signature.png">
    </div> <!-- /container -->
  </body>
</html>
